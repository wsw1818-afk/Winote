build:
  name: Flutter iOS Build
  steps:
    - eas/checkout

    - run:
        name: Install Flutter SDK
        command: |
          set -x
          git clone https://github.com/flutter/flutter.git --depth 1 -b stable $HOME/flutter
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"
          flutter --version

    - run:
        name: Flutter Precache and Config
        command: |
          set -x
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"

          flutter config --no-analytics

          # Force download all iOS artifacts
          flutter precache --ios --force

          # Verify podhelper exists after precache
          ls -la $HOME/flutter/packages/flutter_tools/bin/podhelper.rb || {
            echo "ERROR: podhelper.rb still missing after precache"
            echo "Flutter directory structure:"
            find $HOME/flutter/packages/flutter_tools/bin -type f | head -20
            exit 1
          }

    - run:
        name: Flutter Doctor and Pub Get
        command: |
          set -x
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"

          flutter doctor -v || true
          flutter clean || true
          flutter pub get

    - run:
        name: Install CocoaPods
        command: |
          set -x
          sudo gem install cocoapods
          pod --version

    - run:
        name: Pod Install
        command: |
          set -x
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"
          export FLUTTER_ROOT="$HOME/flutter"

          # CocoaPods 캐시 완전 정리
          pod cache clean --all || true
          rm -rf ~/.cocoapods/repos/trunk || true

          # CocoaPods 저장소 강제 업데이트
          pod repo update --verbose

          cd ios
          rm -rf Pods Podfile.lock .symlinks

          # Pod install 실행
          pod install --verbose

          cd ..

    - run:
        name: Build iOS
        command: |
          set -x
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"

          flutter build ios --release --no-codesign --verbose

          ls -lah build/ios/iphoneos/
          find build/ios/iphoneos -name "*.app" -type d

    - eas/find_and_upload_build_artifacts
