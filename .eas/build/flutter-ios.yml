build:
  name: Flutter iOS Build
  steps:
    - eas/checkout

    - run:
        name: Install Flutter SDK
        command: |
          set -x
          git clone https://github.com/flutter/flutter.git --depth 1 -b stable $HOME/flutter
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"
          flutter --version

    - run:
        name: Flutter Precache and Config
        command: |
          set -x
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"

          flutter config --no-analytics
          flutter precache --ios --force

          if [ ! -f "$HOME/flutter/packages/flutter_tools/bin/podhelper.rb" ]; then
            echo "ERROR: podhelper.rb not found"
            exit 1
          fi
          echo "✅ podhelper.rb found"

    - run:
        name: Flutter Pub Get
        command: |
          set -x
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"

          flutter clean || true
          flutter pub get

    - run:
        name: Install CocoaPods (Isolated Gem Environment)
        command: |
          set -x

          export GEM_HOME="$HOME/cocoapods_gems"
          export GEM_PATH="$HOME/cocoapods_gems"
          export PATH="$HOME/cocoapods_gems/bin:$PATH"
          mkdir -p "$GEM_HOME"

          gem install cocoapods --no-document
          pod --version

          # Initialize CDN trunk repo (required for fresh install)
          echo "=== Initializing CocoaPods CDN trunk ==="
          pod repo add-cdn trunk https://cdn.cocoapods.org/ 2>/dev/null || echo "trunk already exists or CDN mode"
          pod repo list

          echo "✅ CocoaPods ready"

    - run:
        name: Pod Install
        command: |
          set +x

          export GEM_HOME="$HOME/cocoapods_gems"
          export GEM_PATH="$HOME/cocoapods_gems"
          export PATH="$HOME/cocoapods_gems/bin:$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"
          export FLUTTER_ROOT="$HOME/flutter"

          cd ios
          rm -rf Pods Podfile.lock .symlinks

          echo "=== Pod install with --repo-update ==="

          # Run pod install, capture ALL output to file (no tee/pipe issues)
          pod install --repo-update --verbose > /tmp/pod_log.txt 2>&1 || POD_FAILED=true

          # Always show last 80 lines (visible even on failure)
          echo ""
          echo "=========================================="
          echo "=== POD INSTALL LOG (last 80 lines) ==="
          echo "=========================================="
          tail -80 /tmp/pod_log.txt

          if [ "$POD_FAILED" = "true" ]; then
            echo ""
            echo "=========================================="
            echo "=== POD INSTALL FAILED ==="
            echo "=========================================="
            echo ""
            echo "=== ERROR LINES ==="
            grep -i "error\|fail\|unable\|invalid\|cannot\|not found\|could not\|incompatible\|conflict" /tmp/pod_log.txt | head -30
            exit 1
          fi

          echo "✅ Pod install completed successfully"
          cd ..

    - run:
        name: Build iOS
        command: |
          set -x
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"

          flutter build ios --release --no-codesign --verbose

          ls -lah build/ios/iphoneos/
          find build/ios/iphoneos -name "*.app" -type d

    - eas/find_and_upload_build_artifacts
