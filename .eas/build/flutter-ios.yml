build:
  name: Flutter iOS Build
  steps:
    - eas/checkout

    - run:
        name: Setup Environment
        command: |
          set -x

          # Increase timeout for network operations
          export GIT_HTTP_LOW_SPEED_LIMIT=1000
          export GIT_HTTP_LOW_SPEED_TIME=60

          echo "Environment ready"

    - run:
        name: Install Flutter SDK
        command: |
          set -x

          echo "========== Cloning Flutter (with retry) =========="
          for i in {1..3}; do
            git clone https://github.com/flutter/flutter.git --depth 1 -b stable $HOME/flutter && break
            echo "Clone attempt $i failed, retrying..."
            sleep 5
          done

          if [ ! -d "$HOME/flutter" ]; then
            echo "ERROR: Flutter clone failed after 3 attempts"
            exit 1
          fi

          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"
          flutter --version
          flutter config --no-analytics

          echo "Flutter SDK installed successfully"

    - run:
        name: Flutter Doctor and Precache
        command: |
          set -x
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"

          flutter doctor -v || true
          flutter precache --ios || true

    - run:
        name: Flutter Pub Get
        command: |
          set -x
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"

          flutter clean || true
          flutter pub get

          echo "Pub get completed"
          ls -la .flutter-plugins 2>/dev/null || echo "No .flutter-plugins"

    - run:
        name: Verify iOS Setup
        command: |
          set -x

          echo "========== Check iOS directory =========="
          ls -la ios/

          echo "========== Check Podfile =========="
          cat ios/Podfile

          echo "========== Check Generated.xcconfig =========="
          cat ios/Flutter/Generated.xcconfig || echo "Generated.xcconfig missing"

    - run:
        name: Install CocoaPods
        command: |
          set -x

          # Install specific version to avoid compatibility issues
          sudo gem install cocoapods -v 1.15.2 || gem install cocoapods -v 1.15.2
          pod --version

    - run:
        name: Pod Install
        command: |
          set -x
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"
          export FLUTTER_ROOT="$HOME/flutter"

          cd ios

          # Clean start
          rm -rf Pods Podfile.lock .symlinks

          echo "========== Podfile flutter_root check =========="
          ruby -e "
            def flutter_root
              return ENV['FLUTTER_ROOT'] if ENV['FLUTTER_ROOT']
              return File.expand_path('~/flutter') if File.exist?(File.expand_path('~/flutter/bin/flutter'))
              'NOT FOUND'
            end
            puts \"Flutter root: #{flutter_root}\"
            puts \"Flutter bin exists: #{File.exist?(flutter_root + '/bin/flutter')}\"
          "

          # Pod install with timeout protection
          timeout 600 pod install --repo-update --verbose || {
            echo "Pod install with repo update failed or timed out, trying without repo update..."
            timeout 600 pod install --verbose || {
              echo "ERROR: Pod install failed"
              exit 1
            }
          }

          cd ..
          echo "Pod install completed"

    - run:
        name: Build iOS
        command: |
          set -x
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"

          echo "========== Starting iOS build =========="
          flutter build ios --release --no-codesign --verbose

          echo "========== Verify build output =========="
          ls -lah build/ios/iphoneos/
          find build/ios/iphoneos -name "*.app" -type d

    - eas/find_and_upload_build_artifacts
