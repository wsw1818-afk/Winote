build:
  name: Flutter iOS Build
  steps:
    - eas/checkout

    - run:
        name: Install Flutter SDK
        command: |
          set -x
          git clone https://github.com/flutter/flutter.git --depth 1 -b stable $HOME/flutter
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"
          flutter --version

    - run:
        name: Flutter Precache and Config
        command: |
          set -x
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"

          flutter config --no-analytics

          # Force download all iOS artifacts
          flutter precache --ios --force

          # Verify Flutter tools structure
          echo "=== Flutter tools directory structure ==="
          ls -la $HOME/flutter/packages/flutter_tools/bin/ || echo "bin directory not found"

          # Verify podhelper.rb exists
          if [ ! -f "$HOME/flutter/packages/flutter_tools/bin/podhelper.rb" ]; then
            echo "ERROR: podhelper.rb not found after precache"
            echo "Searching for podhelper files:"
            find $HOME/flutter -name "*podhelper*" 2>/dev/null || echo "No podhelper files found"
            echo "Flutter packages structure:"
            ls -la $HOME/flutter/packages/ 2>/dev/null || echo "packages directory not found"
            exit 1
          fi

          echo "✅ podhelper.rb found successfully"

    - run:
        name: Flutter Doctor and Pub Get
        command: |
          set -x
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"

          flutter doctor -v || true
          flutter clean || true
          flutter pub get

    - run:
        name: Install CocoaPods
        command: |
          set -x
          sudo gem install cocoapods
          pod --version

    - run:
        name: Pod Install
        command: |
          set -x
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"
          export FLUTTER_ROOT="$HOME/flutter"

          cd ios

          # Clean previous install
          rm -rf Pods Podfile.lock .symlinks

          # Verify FLUTTER_ROOT is accessible
          echo "=== Flutter root verification ==="
          echo "FLUTTER_ROOT=$FLUTTER_ROOT"
          ls -la "$FLUTTER_ROOT/packages/flutter_tools/bin/podhelper.rb" || {
            echo "ERROR: podhelper.rb not accessible from ios directory"
            exit 1
          }

          # Pod install without repo update (faster, uses CDN cache)
          echo "=== Starting Pod install ==="
          pod install --verbose || {
            echo "ERROR: Pod install failed"
            echo "=== Pod environment ==="
            pod --version
            pod env
            exit 1
          }

          echo "✅ Pod install completed successfully"
          cd ..

    - run:
        name: Build iOS
        command: |
          set -x
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"

          flutter build ios --release --no-codesign --verbose

          ls -lah build/ios/iphoneos/
          find build/ios/iphoneos -name "*.app" -type d

    - eas/find_and_upload_build_artifacts
