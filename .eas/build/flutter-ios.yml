build:
  name: Flutter iOS Build
  steps:
    - eas/checkout

    - run:
        name: Install Flutter SDK
        command: |
          set -x
          git clone https://github.com/flutter/flutter.git --depth 1 -b stable $HOME/flutter
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"
          flutter --version

    - run:
        name: Flutter Precache and Config
        command: |
          set -x
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"

          flutter config --no-analytics
          flutter precache --ios --force

          # Verify podhelper.rb exists
          if [ ! -f "$HOME/flutter/packages/flutter_tools/bin/podhelper.rb" ]; then
            echo "ERROR: podhelper.rb not found"
            find $HOME/flutter -name "*podhelper*" 2>/dev/null
            exit 1
          fi
          echo "✅ podhelper.rb found"

    - run:
        name: Flutter Doctor and Pub Get
        command: |
          set -x
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"

          flutter doctor -v || true
          flutter clean || true
          flutter pub get

    - run:
        name: Setup CocoaPods via Bundler and Pod Install
        command: |
          set -x
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"
          export FLUTTER_ROOT="$HOME/flutter"

          cd ios

          # Clean previous install
          rm -rf Pods Podfile.lock .symlinks

          # Remove any existing broken CocoaPods
          echo "=== Cleaning existing CocoaPods ==="
          sudo gem uninstall cocoapods --all --executables --force 2>/dev/null || true
          sudo gem uninstall cocoapods-core --all --force 2>/dev/null || true
          sudo gem uninstall cocoapods-downloader --all --force 2>/dev/null || true
          sudo gem uninstall cocoapods-plugins --all --force 2>/dev/null || true
          sudo gem uninstall cocoapods-search --all --force 2>/dev/null || true
          sudo gem uninstall cocoapods-trunk --all --force 2>/dev/null || true
          sudo gem uninstall cocoapods-try --all --force 2>/dev/null || true
          sudo gem uninstall cocoapods-deintegrate --all --force 2>/dev/null || true

          # Create Gemfile for clean CocoaPods install
          echo "=== Creating Gemfile ==="
          cat > Gemfile << 'GEMEOF'
          source 'https://rubygems.org'
          gem 'cocoapods', '~> 1.16'
          GEMEOF

          # Install Bundler and CocoaPods via Bundler
          echo "=== Installing via Bundler ==="
          gem install bundler --no-document
          bundle install

          # Verify installation
          echo "=== Verifying CocoaPods ==="
          bundle exec pod --version
          bundle exec gem list | grep cocoapods

          # Verify FLUTTER_ROOT
          echo "=== FLUTTER_ROOT=$FLUTTER_ROOT ==="
          ls -la "$FLUTTER_ROOT/packages/flutter_tools/bin/podhelper.rb"

          # Pod install via Bundler
          echo "=== Starting Pod install ==="
          bundle exec pod install --verbose

          echo "✅ Pod install completed successfully"
          cd ..

    - run:
        name: Build iOS
        command: |
          set -x
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"

          flutter build ios --release --no-codesign --verbose

          ls -lah build/ios/iphoneos/
          find build/ios/iphoneos -name "*.app" -type d

    - eas/find_and_upload_build_artifacts
