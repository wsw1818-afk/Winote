build:
  name: Flutter iOS Build
  steps:
    - eas/checkout

    - run:
        name: Install Flutter SDK
        command: |
          set -x
          git clone https://github.com/flutter/flutter.git --depth 1 -b stable $HOME/flutter
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"
          flutter --version

    - run:
        name: Flutter Precache and Config
        command: |
          set -x
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"

          flutter config --no-analytics
          flutter precache --ios --force

          # Verify podhelper.rb exists
          if [ ! -f "$HOME/flutter/packages/flutter_tools/bin/podhelper.rb" ]; then
            echo "ERROR: podhelper.rb not found"
            find $HOME/flutter -name "*podhelper*" 2>/dev/null
            exit 1
          fi
          echo "✅ podhelper.rb found"

    - run:
        name: Flutter Doctor and Pub Get
        command: |
          set -x
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"

          flutter doctor -v || true
          flutter clean || true
          flutter pub get

    - run:
        name: Install CocoaPods (Isolated Gem Environment)
        command: |
          set -x

          # Create completely isolated gem environment
          export GEM_HOME="$HOME/cocoapods_gems"
          export GEM_PATH="$HOME/cocoapods_gems"
          export PATH="$HOME/cocoapods_gems/bin:$PATH"
          mkdir -p "$GEM_HOME"

          echo "=== Isolated gem environment ==="
          echo "GEM_HOME=$GEM_HOME"
          echo "GEM_PATH=$GEM_PATH"

          # Fresh install CocoaPods in isolated environment
          gem install cocoapods --no-document

          # Verify
          echo "=== Installed gems ==="
          gem list | grep cocoapods
          pod --version
          echo "✅ CocoaPods installed in isolated environment"

    - run:
        name: Pod Install
        command: |
          set -x

          # Restore isolated gem environment
          export GEM_HOME="$HOME/cocoapods_gems"
          export GEM_PATH="$HOME/cocoapods_gems"
          export PATH="$HOME/cocoapods_gems/bin:$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"
          export FLUTTER_ROOT="$HOME/flutter"

          cd ios
          rm -rf Pods Podfile.lock .symlinks

          echo "=== FLUTTER_ROOT=$FLUTTER_ROOT ==="
          ls -la "$FLUTTER_ROOT/packages/flutter_tools/bin/podhelper.rb"

          # Pod install with full error capture
          echo "=== Starting Pod install ==="
          set +e
          pod install --verbose 2>&1 | tee /tmp/pod_log.txt
          POD_EXIT=$?
          set -e

          if [ $POD_EXIT -ne 0 ]; then
            echo ""
            echo "========================================"
            echo "=== POD INSTALL FAILED (exit $POD_EXIT) ==="
            echo "========================================"
            echo ""
            echo "=== ERROR LINES ==="
            grep -i "error\|fail\|unable\|invalid\|cannot\|not found\|could not" /tmp/pod_log.txt | head -30
            echo ""
            echo "=== LAST 50 LINES ==="
            tail -50 /tmp/pod_log.txt
            exit 1
          fi

          echo "✅ Pod install completed successfully"
          cd ..

    - run:
        name: Build iOS
        command: |
          set -x
          export PATH="$HOME/flutter/bin:$HOME/flutter/bin/cache/dart-sdk/bin:$PATH"

          flutter build ios --release --no-codesign --verbose

          ls -lah build/ios/iphoneos/
          find build/ios/iphoneos -name "*.app" -type d

    - eas/find_and_upload_build_artifacts
